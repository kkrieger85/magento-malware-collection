How to
======

This document will briefly cover the most important aspects of the magento-malware-scanner.

1. Installation
2. How to use the Scanner
3. How to add malware
4. Test your rules

# 1. Installation

The requirements for the magento-malware-scanner to work are:

* python3
* yara

__Installation on Debian/Ubuntu flavoured server__

```bash
# Install prerequisites on Debian/Ubuntu flavoured server
sudo apt install yara python3
```
__Installation on a Mac OSX environment__

```bash
# Install prerequisites on a Mac OSX environemnt
brew install yara python3
```

__Checkout repository__

```bash
# Checkout repository. 
git clone https://github.com/gwillem/magento-malware-scanner.git
cd magento-malware-collection
```
__Verify that everything is working__

```bash
# Run tests to validate signatures and samples
python tools/runtests.py
```

# 2. How to use the Scanner

After installing the requirements, a scan can be initiated with basically 3 ingredients in a terminal command.

1. yara
2. yara rules (./rules/all-confirmed.yar)
3. target (Magento document root)

__Example recursive scan__

```bash
yara -r /path/to/magento-scanner/rules/all-confirmed.yar /path/to/magento/document-root
```

When there's malware detected, your output will look something similar like:

```
$ yara -r rules/all-confirmed.yar /Users/frosit/Werk/Security/mage17

eval_post /Users/frosit/Werk/Security/mage17/media/dhl/info.php
obfuscated_eval /Users/frosit/Werk/Security/mage17/skin/backdoor1.php
```

# 3. How to add malware

After installing the requirements, malware can be added by following these steps.

## Gather your malware samples

Gather your malware samples in the `malware/incoming` folder of the _magento-malware-scanner_. To check if your samples aren't already detected by the current set of rules.

```bash
yara -r ./rules/all-confirmed.yar ./malware/incoming
```

If your sample is already detected for the right reasons, you may skip this sample.

## Process the samples

Running `md5_to_incoming.sh` will move your samples to the `malware/backend` directory and rename them with an md5 checksum.

```bash
./tools/md5_to_incoming.sh
```

We can now generate boilerplate rules using `tools/runtests.py`. This will make sure that each sample is covered by a YARA rule. If not, a boilerplate rule will be outputted.

__example output__

```
// malware/backend/4c4b3d4ba5bce7191a5138efa2468679
rule md5_4c4b3d4ba5bce7191a5138efa2468679 {
    strings: $ = ""
    condition: any of them
}
```

Copy over the boilerplate rule(s) to `rules/backend.yar` and start editing them.

## Creating rules

Using the boilerplate rules, creating a rule can be as simple as defining a string to match.
Malware signatures can be extremely specific (a file checksum) or too generic (check for suspicious `eval()`).

__Example malware__

```PHP
<?php @eval(stripslashes($_REQUEST[q]));
```
__Example rule__

```
rule md5_d201d61510f7889f1a47257d52b15fa2 { // rule name (sample filename or descriptive name)
    strings: $ = "@eval(stripslashes($_REQUEST[q]));" // string(s) to match
    condition: any of them  // conditions
}
```

The above example is simple and sufficient. More advanced samples may require more complex signatures. One signature can cover multiple strains of malware. A signature can also _raise a false positive which should be prevented at all costs_. You have to decide on a _proper balance_.

__When in doubt, go specific__ as it has the least chance to raise a false flag. 

For more information on writing rules, refer to the documentation below

* [Writing YARA rules](http://yara.readthedocs.io/en/v3.5.0/writingrules.html)
* [YARA in a Nutshell](http://virustotal.github.io/yara/)
* [Example Yara Rules](https://github.com/Yara-Rules/rules)

# 4. Test your rules

This repository contains 2 tools and automated tests to make sure samples and fingerprints have at least one match and don't raise false flags.
Run these before sending a pull request.

## Verifying that samples and fingerprints have matches

To verify this, run the following command from the project root:

```bash
python tools/runtests.py
```

## Checking for false flags against vanilla Magento code

The `tools/mageffcheck.sh` bash script has a couple of commands available to get you started.
The idea is to download and extract various vanilla Magento packages and run the YARA tests against it.
When these tests return output, it's most likely a false flag.

Running the following command will output some information:

```bash
./tools/mageffcheck.sh

# OR

./tools/mageffcheck.sh help
```

You can initialize the test setup by appending the `init` argument

```bash
./tools/mageffcheck.sh init
```

This will download and extract several Magento packages from the [OpenMage Magento Mirror](https://github.com/OpenMage/magento-mirror).

__Note: When using an IDE__

Downloading and extracting several Magento package may trigger the IDE's indexation. Due to the amount of code it may lag or even hang (for a while).
These packages will be stored in `./tmp` make sure to _mark this directory as excluded_ before or right after running `init`.

After this you could run the following to trigger the YARA tests against the vanilla code.

```bash
./tools/mageffcheck.sh run
```
You should expect _no output_ from running this command.
